import time

def search_city_by_paste(city_pinyin, d):
    """
    ç»ˆææ–¹æ¡ˆ (èåˆç‰ˆ)ï¼š
    1. è¾“å…¥ï¼šä½¿ç”¨ ADB Shell è¾“å…¥æ‹¼éŸ³ (æœ€ç¨³è¾“å…¥æ–¹å¼)
    2. é€‰æ‹©ï¼šä½¿ç”¨ Resource-ID æ­£åˆ™åŒ¹é… (æœ€ç¨³é€‰æ‹©æ–¹å¼)
       - P0: å‘ç°å­é€‰é¡¹æŒ‰é’® (SubAreaButton) -> ç›´æ¥ç‚¹ç¬¬ä¸€ä¸ª
       - P1: å‘ç° [åŸå¸‚] æ ‡ç­¾ -> ç‚¹æ ‡ç­¾å³ä¾§
       - P2: å‘ç° [è½¦ç«™]/[æœºåœº] -> ç›´æ¥ç‚¹
       - P3: ç›²ç‚¹ç¬¬ä¸€è¡Œ
    """
    print(f"--- ğŸ” å¯åŠ¨æ™ºèƒ½æœç´¢æµç¨‹ï¼š{city_pinyin} ---")
    
    # =======================================
    # ç¬¬ä¸€æ­¥ï¼šæ¿€æ´»æœç´¢æ¡†å¹¶è¾“å…¥
    # =======================================
    
    # 1. ç‚¹å‡»æœç´¢æ¡†
    search_input_id = "car_testid_page_location_searchinput_input"
    
    if d(resourceId=search_input_id).exists:
        d(resourceId=search_input_id).click()
    else:
        # å¤‡ç”¨ï¼šç‚¹æ–‡å­— "åŸå¸‚"
        d(textContains="åŸå¸‚").click()
    
    time.sleep(1) # ç­‰é”®ç›˜å¼¹å‡ºæ¥
    
    # 2. ä½¿ç”¨ ADB Shell è¾“å…¥æ‹¼éŸ³
    print(f"æ­£åœ¨æ•²å…¥æ‹¼éŸ³: {city_pinyin}")
    d.shell(f"input text {city_pinyin}")
    
    print("ç­‰å¾…æœç´¢ç»“æœåˆ·æ–°...")
    time.sleep(3) # ç»™ç½‘ç»œä¸€ç‚¹æ—¶é—´
    
    # =======================================
    # ç¬¬äºŒæ­¥ï¼šæ™ºèƒ½é€‰æ‹©æœ€ä½³ç»“æœ (ä¼˜å…ˆçº§ç­–ç•¥)
    # =======================================
    
    # ç­–ç•¥ P0 (æœ€é«˜ä¼˜)ï¼šç²¾å‡†æ‰“å‡»â€œå­é€‰é¡¹æŒ‰é’®â€
    # åœºæ™¯ï¼šæœ "zhengzhou" æˆ– "linzhi" æ—¶ï¼Œä¼šå‡ºç°å¸¦ "SubAreaButton" ID çš„æŒ‰é’®
    # åªè¦å‡ºç°äº†è¿™ä¸ªï¼Œè¯´æ˜æ˜¯æ ¸å¿ƒåŸå¸‚ï¼Œç›´æ¥ç‚¹ç¬¬ä¸€ä¸ªå­æŒ‰é’®ï¼Œæ— éœ€ç®—åæ ‡
    sub_buttons = d(resourceIdMatches=".*SubAreaButton_.*")
    
    if sub_buttons.exists:
        print("âœ… å‘½ä¸­ P0 ç­–ç•¥ï¼šå‘ç°åŸå¸‚å­é€‰é¡¹ï¼Œç‚¹å‡»ç¬¬ä¸€ä¸ªå­åœ°ç‚¹...")
        # è·å–ç¬¬ä¸€ä¸ªåŒ¹é…åˆ°çš„æŒ‰é’®æ–‡æœ¬ï¼Œæ–¹ä¾¿è°ƒè¯•
        first_btn_text = sub_buttons[0].info.get('text', 'æœªçŸ¥æŒ‰é’®')
        print(f"ğŸ‘‰ å³å°†ç‚¹å‡»: {first_btn_text}")
        
        sub_buttons[0].click()
        return

    # ç­–ç•¥ P1ï¼šæ²¡æœ‰å­é€‰é¡¹ï¼Œä½†æœ‰ [åŸå¸‚] æ ‡ç­¾
    # åœºæ™¯ï¼šæœä¸€ä¸ªå°åŸå¸‚ï¼Œæ²¡æœ‰æœºåœºè½¦ç«™ï¼Œåªæœ‰ä¸€è¡ŒåŸå¸‚å
    if d(text="åŸå¸‚").exists:
        print("âœ… å‘½ä¸­ P1 ç­–ç•¥ï¼šæ‰¾åˆ° [åŸå¸‚] æ ‡ç­¾ (æ— å­é€‰é¡¹)...")
        
        # æ—¢ç„¶æ²¡æœ‰å­æŒ‰é’®ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªç®€å•åˆ—è¡¨é¡¹
        # æˆ‘ä»¬ä½¿ç”¨â€œåç§»ç‚¹å‡»æ³•â€ç‚¹æ ‡ç­¾å³è¾¹ï¼Œç¡®ä¿ç‚¹ä¸­æ–‡å­—
        try:
            tag_bounds = d(text="åŸå¸‚").info['bounds']
            # è®¡ç®—æ ‡ç­¾å³ä¾§ 150px çš„ä½ç½®
            click_x = tag_bounds['right'] + 150
            click_y = (tag_bounds['top'] + tag_bounds['bottom']) / 2
            
            print(f"ğŸ“ æ‰§è¡Œåç§»ç‚¹å‡»: ({click_x}, {click_y})")
            d.click(click_x, click_y)
        except:
            # å¦‚æœè·å–åæ ‡å¤±è´¥ï¼Œå›é€€åˆ°ç‚¹å‡»æ ‡ç­¾æœ¬èº«ï¼ˆè™½ç„¶å¯èƒ½ä¸çµï¼‰
            d(text="åŸå¸‚").click()
        return

    # ç­–ç•¥ P2ï¼šæ¬¡çº§æ¢çº½ â€”â€” å¯»æ‰¾ã€è½¦ç«™ã€‘æˆ–ã€æœºåœºã€‘
    # åœºæ™¯ï¼šæœ "zhengzhoudong" (éƒ‘å·ä¸œ)
    if d(text="è½¦ç«™").exists:
        print("âœ… å‘½ä¸­ P2 ç­–ç•¥ï¼šæ‰¾åˆ° [è½¦ç«™] æ ‡ç­¾ã€‚")
        d(text="è½¦ç«™").click()
        return
    
    if d(text="æœºåœº").exists:
        print("âœ… å‘½ä¸­ P2 ç­–ç•¥ï¼šæ‰¾åˆ° [æœºåœº] æ ‡ç­¾ã€‚")
        d(text="æœºåœº").click()
        return

    # ç­–ç•¥ P3ï¼šä¿åº•ç­–ç•¥ â€”â€” ç‚¹å‡»åˆ—è¡¨ç¬¬ä¸€é¡¹
    # åœºæ™¯ï¼šæœäº†ä¸€ä¸ªå¾ˆåçš„åœ°æ–¹ï¼Œæˆ–è€… UI å˜äº†ï¼Œä»€ä¹ˆæ ‡éƒ½æ²¡è®¤å‡ºæ¥
    print("âš ï¸ å‘½ä¸­ P3 (ä¿åº•)ï¼šæœªæ‰¾åˆ°ç‰¹å®šæ ‡ç­¾ï¼Œç›²ç‚¹åˆ—è¡¨ç¬¬ä¸€é¡¹ã€‚")
    d.click(0.5, 0.25)

